From b1dd7dc54df83725b38a2cc926ddf1d93ca18cc3 Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Fri, 17 Jun 2016 17:55:08 +0000
Subject: [PATCH] Add Clear Linux distro support

---
 azurelinuxagent/distro/clearlinux/__init__.py    | 18 +++++
 azurelinuxagent/distro/clearlinux/deprovision.py | 31 ++++++++
 azurelinuxagent/distro/clearlinux/distro.py      | 29 ++++++++
 azurelinuxagent/distro/clearlinux/osutil.py      | 90 +++++++++++++++++++++++
 azurelinuxagent/distro/loader.py                 |  3 +
 config/clearlinux/waagent.conf                   | 91 ++++++++++++++++++++++++
 init/clearlinux/waagent.service                  | 12 ++++
 setup.py                                         |  6 ++
 8 files changed, 280 insertions(+)
 create mode 100644 azurelinuxagent/distro/clearlinux/__init__.py
 create mode 100644 azurelinuxagent/distro/clearlinux/deprovision.py
 create mode 100644 azurelinuxagent/distro/clearlinux/distro.py
 create mode 100644 azurelinuxagent/distro/clearlinux/osutil.py
 create mode 100644 config/clearlinux/waagent.conf
 create mode 100755 init/clearlinux/waagent.service

diff --git a/azurelinuxagent/distro/clearlinux/__init__.py b/azurelinuxagent/distro/clearlinux/__init__.py
new file mode 100644
index 0000000..8c1bbdb
--- /dev/null
+++ b/azurelinuxagent/distro/clearlinux/__init__.py
@@ -0,0 +1,18 @@
+# Microsoft Azure Linux Agent
+#
+# Copyright 2014 Microsoft Corporation
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# Requires Python 2.4+ and Openssl 1.0+
+#
diff --git a/azurelinuxagent/distro/clearlinux/deprovision.py b/azurelinuxagent/distro/clearlinux/deprovision.py
new file mode 100644
index 0000000..f295111
--- /dev/null
+++ b/azurelinuxagent/distro/clearlinux/deprovision.py
@@ -0,0 +1,31 @@
+# Microsoft Azure Linux Agent
+#
+# Copyright 2014 Microsoft Corporation
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# Requires Python 2.4+ and Openssl 1.0+
+#
+
+import azurelinuxagent.utils.fileutil as fileutil
+from azurelinuxagent.distro.default.deprovision import DeprovisionHandler, DeprovisionAction
+
+class ClearLinuxDeprovisionHandler(DeprovisionHandler):
+    def __init__(self, distro):
+        self.distro = distro
+
+    def setup(self, deluser):
+        warnings, actions = super(ClearLinuxDeprovisionHandler, self).setup(deluser)
+        # Probably should just wipe /etc and /var here
+        return warnings, actions
+
diff --git a/azurelinuxagent/distro/clearlinux/distro.py b/azurelinuxagent/distro/clearlinux/distro.py
new file mode 100644
index 0000000..9823d38
--- /dev/null
+++ b/azurelinuxagent/distro/clearlinux/distro.py
@@ -0,0 +1,29 @@
+# Microsoft Azure Linux Agent
+#
+# Copyright 2014 Microsoft Corporation
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# Requires Python 2.4+ and Openssl 1.0+
+#
+
+from azurelinuxagent.distro.default.distro import DefaultDistro
+from azurelinuxagent.distro.clearlinux.osutil import ClearLinuxUtil
+from azurelinuxagent.distro.clearlinux.deprovision import ClearLinuxDeprovisionHandler
+
+class ClearLinuxDistro(DefaultDistro):
+    def __init__(self):
+        super(ClearLinuxDistro, self).__init__()
+        self.osutil = ClearLinuxUtil()
+        self.deprovision_handler = ClearLinuxDeprovisionHandler(self)
+
diff --git a/azurelinuxagent/distro/clearlinux/osutil.py b/azurelinuxagent/distro/clearlinux/osutil.py
new file mode 100644
index 0000000..10fbcd3
--- /dev/null
+++ b/azurelinuxagent/distro/clearlinux/osutil.py
@@ -0,0 +1,90 @@
+#
+# Copyright 2014 Microsoft Corporation
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# Requires Python 2.4+ and Openssl 1.0+
+#
+
+import os
+import re
+import pwd
+import shutil
+import socket
+import array
+import struct
+import fcntl
+import time
+import base64
+import azurelinuxagent.logger as logger
+import azurelinuxagent.utils.fileutil as fileutil
+import azurelinuxagent.utils.shellutil as shellutil
+import azurelinuxagent.utils.textutil as textutil
+from azurelinuxagent.distro.default.osutil import DefaultOSUtil
+
+class ClearLinuxUtil(DefaultOSUtil):
+    def __init__(self):
+        super(ClearLinuxUtil, self).__init__()
+        self.agent_conf_file_path = '/usr/share/defaults/waagent/waagent.conf'
+
+    def is_dhcp_enabled(self):
+        return True
+
+    def start_network(self) :
+        return shellutil.run("systemctl start systemd-networkd", chk_err=False)
+
+    def restart_if(self, iface):
+        shellutil.run("systemctl restart systemd-networkd")
+
+    def restart_ssh_service(self):
+        # SSH is socket activated. No need to restart it.
+        pass
+
+    def stop_dhcp_service(self):
+        return shellutil.run("systemctl stop systemd-networkd", chk_err=False)
+
+    def start_dhcp_service(self):
+        return shellutil.run("systemctl start systemd-networkd", chk_err=False)
+
+    def start_agent_service(self):
+        return shellutil.run("systemctl start wagent", chk_err=False)
+
+    def stop_agent_service(self):
+        return shellutil.run("systemctl stop wagent", chk_err=False)
+
+    def get_dhcp_pid(self):
+        ret= shellutil.run_get_output("pidof systemd-networkd")
+        return ret[1] if ret[0] == 0 else None
+
+    def conf_sshd(self, disable_password):
+        # Don't whack the system default sshd conf
+        pass
+
+    def del_root_password(self):
+        try:
+            passwd_file_path = conf.get_passwd_file_path()
+            try:
+                passwd_content = fileutil.read_file(passwd_file_path)
+                if not passwd_content:
+                    # Empty file is no better than no file
+                    raise FileNotFoundError
+            except FileNotFoundError:
+                new_passwd = ["root:*LOCK*:14600::::::"]
+            else:
+                passwd = passwd_content.split('\n')
+                new_passwd = [x for x in passwd if not x.startswith("root:")]
+                new_passwd.insert(0, "root:*LOCK*:14600::::::")
+            fileutil.write_file(passwd_file_path, "\n".join(new_passwd))
+        except IOError as e:
+            raise OSUtilError("Failed to delete root password:{0}".format(e))
+        pass
diff --git a/azurelinuxagent/distro/loader.py b/azurelinuxagent/distro/loader.py
index f6800b3..7f47ffc 100644
--- a/azurelinuxagent/distro/loader.py
+++ b/azurelinuxagent/distro/loader.py
@@ -25,6 +25,7 @@ from azurelinuxagent.distro.ubuntu.distro import UbuntuDistro, \
                                                  Ubuntu12Distro, \
                                                  UbuntuSnappyDistro
 from azurelinuxagent.distro.redhat.distro import RedhatDistro, Redhat6xDistro
+from azurelinuxagent.distro.clearlinux.distro import ClearLinuxDistro
 from azurelinuxagent.distro.coreos.distro import CoreOSDistro
 from azurelinuxagent.distro.suse.distro import SUSE11Distro, SUSEDistro
 from azurelinuxagent.distro.debian.distro import DebianDistro
@@ -45,6 +46,8 @@ def get_distro(distro_name=DISTRO_NAME, distro_version=DISTRO_VERSION,
             return UbuntuDistro()
     if distro_name == "coreos":
         return CoreOSDistro()
+    if distro_name == "clear linux software for intel architecture":
+        return ClearLinuxDistro()
     if distro_name == "suse":
         if distro_full_name=='SUSE Linux Enterprise Server' and \
            Version(distro_version) < Version('12') or \
diff --git a/config/clearlinux/waagent.conf b/config/clearlinux/waagent.conf
new file mode 100644
index 0000000..5af0baf
--- /dev/null
+++ b/config/clearlinux/waagent.conf
@@ -0,0 +1,91 @@
+#
+# Microsoft Azure Linux Agent Configuration
+#
+
+# Specified program is invoked with the argument "Ready" when we report ready status
+# to the endpoint server.
+Role.StateConsumer=None
+
+# Specified program is invoked with XML file argument specifying role
+#  configuration.
+Role.ConfigurationConsumer=None
+
+# Specified program is invoked with XML file argument specifying role topology.
+Role.TopologyConsumer=None
+
+# Enable instance creation
+Provisioning.Enabled=y
+
+# Password authentication for root account will be unavailable.
+Provisioning.DeleteRootPassword=y
+
+# Generate fresh host key pair.
+Provisioning.RegenerateSshHostKeyPair=y
+
+# Supported values are "rsa", "dsa" and "ecdsa".
+Provisioning.SshHostKeyPairType=rsa
+
+# Monitor host name changes and publish changes via DHCP requests.
+Provisioning.MonitorHostName=y
+
+# Decode CustomData from Base64.
+Provisioning.DecodeCustomData=y
+
+# Execute CustomData after provisioning.
+Provisioning.ExecuteCustomData=n
+
+# Algorithm used by crypt when generating password hash.
+#Provisioning.PasswordCryptId=6
+
+# Length of random salt used when generating password hash.
+#Provisioning.PasswordCryptSaltLength=10
+
+# Allow reset password of sys user
+Provisioning.AllowResetSysUser=n
+
+# Format if unformatted. If 'n', resource disk will not be mounted.
+ResourceDisk.Format=y
+
+# File system on the resource disk
+# Typically ext3 or ext4. FreeBSD images should use 'ufs2' here.
+ResourceDisk.Filesystem=ext4
+
+# Mount point for the resource disk
+ResourceDisk.MountPoint=/mnt/resource
+
+# Create and use swapfile on resource disk.
+ResourceDisk.EnableSwap=n
+
+# Size of the swapfile.
+ResourceDisk.SwapSizeMB=0
+
+# Enable verbose logging (y|n)
+Logs.Verbose=n
+
+# Root device timeout in seconds.
+OS.RootDeviceScsiTimeout=300
+
+# If "None", the system default version is used.
+OS.OpensslPath=None
+
+# If set, agent will use proxy server to access internet
+#HttpProxy.Host=None
+#HttpProxy.Port=None
+
+# Detect Scvmm environment, default is n
+# DetectScvmmEnv=n
+
+#
+# Lib.Dir=/var/lib/waagent
+
+#
+# DVD.MountPoint=/mnt/cdrom/secure
+
+#
+# Pid.File=/var/run/waagent.pid
+
+#
+# Extension.LogDir=/var/log/azure
+
+#
+# Home.Dir=/home
diff --git a/init/clearlinux/waagent.service b/init/clearlinux/waagent.service
new file mode 100755
index 0000000..16de66b
--- /dev/null
+++ b/init/clearlinux/waagent.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Azure Linux Agent
+After=network.target
+After=sshd.service
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/waagent -daemon
+Restart=always
+
+[Install]
+WantedBy=multi-user.target
diff --git a/setup.py b/setup.py
index 0cfecff..77388f2 100755
--- a/setup.py
+++ b/setup.py
@@ -81,6 +81,12 @@ def get_data_files(name, version, fullname):
         set_logrotate_files(data_files)
         set_files(data_files, dest="/usr/share/oem", 
                   src=["init/coreos/cloud-config.yml"])
+    elif name == 'clear linux software for intel architecture':
+        set_bin_files(data_files, dest="/usr/bin")
+        set_conf_files(data_files, dest="/usr/share/defaults/waagent",
+                       src=["config/clearlinux/waagent.conf"])
+        set_systemd_files(data_files, dest='/usr/lib/systemd/system',
+                          src=["init/clearlinux/waagent.service"])
     elif name == 'ubuntu':
         set_bin_files(data_files)
         set_conf_files(data_files, src=["config/ubuntu/waagent.conf"])
-- 
2.9.1

